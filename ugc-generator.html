<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI UGC Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-white font-sans min-h-screen flex flex-col items-center p-6">

    <div class="max-w-3xl w-full space-y-8 mt-10">
        
        <!-- Header -->
        <div class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">
                AI UGC Generator
            </h1>
            <p class="text-slate-400">Buat video iklan otomatis dalam hitungan detik.</p>
        </div>

        <!-- Status Box -->
        <div id="statusBox" class="hidden p-4 rounded-lg text-sm text-center"></div>

        <!-- Button -->
        <button id="generateBtn" onclick="startGenerate()" class="w-full py-4 rounded-xl font-bold text-lg bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white shadow-lg hover:shadow-cyan-500/25 transition-all">
            üöÄ Generate Video Sekarang
        </button>

        <!-- Terminal Logs -->
        <div class="bg-black/80 rounded-xl border border-slate-800 p-5 font-mono text-xs md:text-sm h-64 overflow-y-auto shadow-inner relative">
            <div id="logsContainer" class="flex flex-col gap-2">
                <span class="text-slate-600 italic" id="emptyLog">Menunggu perintah...</span>
            </div>
        </div>

        <!-- Video Result -->
        <div id="videoContainer" class="hidden bg-slate-900 rounded-xl p-6 border border-slate-700 animate-fade-in">
            <h3 class="text-xl font-semibold mb-4 text-center">üéâ Hasil Video Anda</h3>
            <div class="relative aspect-video rounded-lg overflow-hidden bg-black shadow-2xl">
                <video id="resultVideo" controls class="w-full h-full object-contain"></video>
            </div>
            <a id="downloadBtn" href="#" download="ugc-video.mp4" target="_blank" class="mt-4 block w-full bg-emerald-600 hover:bg-emerald-500 text-center py-3 rounded-lg font-medium transition-colors">
                Download Video
            </a>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE (Ambil dari Project Settings kamu)
        // Karena ini file HTML, kita harus hardcode KEY ANON di sini atau load dari env jika ada build process.
        // Tapi untuk Static HTML di Vercel, biasanya hardcode PUBLIC KEY aman (Service Role JANGAN DI SINI).
        // Cek Vercel Env Vars: NEXT_PUBLIC_SUPABASE_URL & NEXT_PUBLIC_SUPABASE_ANON_KEY
        
        // PENTING: Ganti string kosong di bawah dengan URL & ANON KEY Supabase kamu secara manual
        // karena HTML static sulit membaca process.env tanpa build tools.
        const supabaseUrl = 'MASUKKAN_URL_SUPABASE_KAMU_DISINI'; 
        const supabaseKey = 'MASUKKAN_ANON_KEY_SUPABASE_KAMU_DISINI';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const logsContainer = document.getElementById('logsContainer');
        const emptyLog = document.getElementById('emptyLog');
        const statusBox = document.getElementById('statusBox');
        const videoContainer = document.getElementById('videoContainer');
        const resultVideo = document.getElementById('resultVideo');
        const downloadBtn = document.getElementById('downloadBtn');
        const generateBtn = document.getElementById('generateBtn');

        function addLog(message) {
            emptyLog.style.display = 'none';
            const div = document.createElement('div');
            div.className = 'text-emerald-400 break-words border-l-2 border-emerald-500/30 pl-2';
            div.innerHTML = `<span class="opacity-50 mr-2">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logsContainer.appendChild(div);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        async function startGenerate() {
            // Reset UI
            logsContainer.innerHTML = '';
            videoContainer.classList.add('hidden');
            statusBox.className = 'hidden';
            generateBtn.disabled = true;
            generateBtn.innerHTML = 'Sedang Memproses...';
            generateBtn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                // 1. Cek User Login
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error("Silakan login terlebih dahulu.");

                addLog("Menghubungkan ke server...");

                // 2. Panggil API Vercel Function
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Gagal memproses.');
                }

                // 3. Baca Stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6);
                                const data = JSON.parse(jsonStr);

                                // Log Logic
                                if (data.msg === 'process_generating' && data.output?.data) {
                                    const rawData = data.output.data;
                                    if (Array.isArray(rawData) && rawData.length > 0) {
                                        const lastLog = rawData[rawData.length - 1];
                                        if (typeof lastLog === 'string' && lastLog.length > 2) {
                                            addLog(lastLog.replace(/\n/g, ' '));
                                        }
                                    }
                                }

                                // Result Logic
                                if (data.msg === 'process_completed') {
                                    const results = data.output.data;
                                    const videoObj = results.find(item => item?.url?.endsWith('.mp4'));
                                    
                                    if (videoObj) {
                                        addLog("‚úÖ SELESAI! Menampilkan video...");
                                        resultVideo.src = videoObj.url;
                                        downloadBtn.href = videoObj.url;
                                        videoContainer.classList.remove('hidden');
                                    }
                                }
                            } catch (e) {}
                        }
                    }
                }

            } catch (err) {
                statusBox.innerText = "‚ö†Ô∏è " + err.message;
                statusBox.className = 'p-4 rounded-lg text-sm text-center bg-red-500/10 border border-red-500 text-red-400 block';
                addLog("ERROR: " + err.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üöÄ Generate Video Sekarang';
                generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
    </script>
</body>
</html>
