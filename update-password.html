<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Password Baru - OrbitBot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 flex items-center justify-center min-h-screen font-sans">

    <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl w-full max-w-md shadow-2xl relative">
        <!-- Logo/Header -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                <i class="fas fa-shield-halved text-blue-400 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">Buat Password Baru</h2>
            <p class="text-slate-400 text-sm">Masukkan password baru untuk akun Anda.</p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Password Baru</label>
                <div class="relative">
                    <input type="password" id="newPassword" placeholder="Min. 6 karakter" 
                        class="w-full bg-slate-950 border border-slate-700 text-white px-5 py-3 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition placeholder-slate-600">
                </div>
            </div>
            
            <button onclick="updatePassword()" id="btnSimpan" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-900/50 hover:scale-[1.02] mt-4">
                Simpan Password
            </button>
            
            <p id="msg" class="text-center text-sm mt-4 min-h-[20px]"></p>

            <div class="text-center mt-6">
                <a href="https://www.orbitbot.pro" class="text-slate-500 hover:text-white text-xs transition">
                    <i class="fas fa-arrow-left mr-1"></i> Kembali ke Beranda
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INISIALISASI SUPABASE (Gunakan nama variabel yang berbeda dari library) ---
        const SUPABASE_URL = 'https://xhjwmhoxrszzrwsmqhxi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoandtaG94cnN6enJ3c21xaHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDg1MjUsImV4cCI6MjA4MzAyNDUyNX0.JfMp7BY0PMhTc3xV2CoM6fTLsHSIrLyJyj9WMgeVFDM';
        
        // Gunakan variabel _supabase agar tidak bentrok dengan library 'supabase'
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. FUNGSI UPDATE PASSWORD ---
        async function updatePassword() {
            const passwordInput = document.getElementById('newPassword');
            const btn = document.getElementById('btnSimpan');
            const msgLabel = document.getElementById('msg');
            const newPassword = passwordInput.value;

            // Validasi Input
            if (newPassword.length < 6) {
                msgLabel.innerText = "Password minimal 6 karakter!";
                msgLabel.className = "text-center text-sm text-yellow-400 mt-4";
                return;
            }

            // Loading State
            btn.disabled = true;
            btn.innerText = "Memproses...";
            msgLabel.innerText = "Sedang mengupdate password...";
            msgLabel.className = "text-center text-sm text-blue-400 mt-4";

            try {
                // Proses Update ke Supabase
                // Supabase otomatis mengenali user dari token yang ada di URL hash
                const { data, error } = await _supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                // Jika Berhasil
                msgLabel.innerText = "✅ Password berhasil diperbarui!";
                msgLabel.className = "text-center text-sm text-green-400 mt-4";
                passwordInput.value = "";
                
                setTimeout(() => {
                    msgLabel.innerText = "Mengalihkan ke beranda...";
                    window.location.href = "https://www.orbitbot.pro"; 
                }, 2000);

            } catch (error) {
                // Jika Gagal
                msgLabel.innerText = "❌ Gagal: " + error.message;
                msgLabel.className = "text-center text-sm text-red-500 mt-4";
                btn.disabled = false;
                btn.innerText = "Simpan Password";
            }
        }

        // --- 3. SECURITY CHECK ---
        // Opsional: Cek apakah user datang dari link reset yang valid
        window.onload = async () => {
            const { data } = await _supabase.auth.getSession();
            if (!data.session) {
                // Jika tidak ada session (user iseng buka halaman ini tanpa link email)
                // Kita tidak langsung usir, tapi beri peringatan jika mereka coba update akan gagal
                console.log("Saran: Pastikan Anda membuka halaman ini dari link reset password di email.");
            }
        };
    </script>
</body>
</html>
