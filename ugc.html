<!-- Bagian HTML tetap sama, GANTI SCRIPT-NYA SAJA -->
<script>
    let base64Image = "";
    let eventSource = null;

    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                base64Image = e.target.result;
                document.getElementById('imagePreview').src = base64Image;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }
    }

    async function startGenerate() {
        if (!base64Image) return alert("Upload foto produk dulu!");
        
        const btn = document.getElementById('btnGen');
        const statusBox = document.getElementById('statusBox');
        
        // Reset UI
        if(eventSource) eventSource.close();
        document.getElementById('resultContainer').classList.remove('hidden');
        resetCards();
        
        statusBox.classList.remove('hidden');
        statusBox.innerText = "1/2 Mengupload Gambar ke Server...";
        statusBox.className = "text-center text-xs font-mono text-yellow-400 animate-pulse pt-2";
        btn.disabled = true; btn.innerHTML = 'Memproses...'; btn.classList.add('opacity-50');

        try {
            // 1. Panggil API Vercel
            const req = await fetch('/api/ugc-process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image_data: base64Image, 
                    prompt: document.getElementById('prompt').value,
                    price: document.getElementById('price').value,
                    desc: document.getElementById('desc').value,
                    timestamp: Date.now()
                })
            });

            const data = await req.json();
            if (!req.ok) throw new Error(data.message || "Gagal Request");

            // 2. Monitoring
            statusBox.innerText = "2/2 Masuk Antrian (Menunggu respon)...";
            const pollingUrl = `${data.space_url}/gradio_api/queue/data?session_hash=${data.session_hash}`;
            
            eventSource = new EventSource(pollingUrl);
            
            // Tangkap Error Koneksi
            eventSource.onerror = (err) => {
                // Jangan panik dulu, kadang cuma putus nyambung
                console.log("Koneksi EventSource berkedip...");
            };

            eventSource.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                
                // DEBUG: Lihat di console apa yg terjadi
                console.log(msg);

                if (msg.msg === 'process_starts') {
                    statusBox.innerText = "ðŸš€ Mesin AI Mulai Bekerja!";
                }

                if (msg.msg === 'process_generating' || msg.msg === 'process_completed') {
                    
                    if(!msg.output || !msg.output.data) return; // Skip jika data kosong
                    const outputs = msg.output.data;
                    
                    // --- FOTO (Index 0) ---
                    if (outputs[0] && Array.isArray(outputs[0])) {
                        activateCard('cardPhoto', 'statusPhoto', 'âœ… Foto Jadi!');
                        const photoGrid = document.getElementById('photoGrid');
                        if(photoGrid.childElementCount !== outputs[0].length) {
                            photoGrid.innerHTML = "";
                            outputs[0].forEach(img => {
                                const url = img.url || img;
                                photoGrid.innerHTML += `<img src="${url}" class="w-full h-24 object-cover rounded border border-gray-600">`;
                            });
                        }
                    }

                    // --- AUDIO (Index 1) ---
                    if (outputs[1]) {
                        activateCard('cardAudio', 'statusAudio', 'âœ… Audio Jadi!');
                        const url = outputs[1].url || outputs[1];
                        const player = document.getElementById('audioPlayer');
                        if(player.src !== url) {
                            player.src = url;
                            player.classList.remove('hidden');
                            document.getElementById('audioPlaceholder').classList.add('hidden');
                        }
                    }

                    // --- VIDEO (Index 2) ---
                    if (outputs[2]) {
                        activateCard('cardVideo', 'statusVideo', 'âœ… Video Final Jadi!');
                        const url = outputs[2].url || outputs[2];
                        const player = document.getElementById('videoPlayer');
                        if(player.src !== url) {
                            player.src = url;
                            player.classList.remove('hidden');
                            document.getElementById('videoLoadingText').classList.add('hidden');
                            document.getElementById('downloadLink').href = url;
                            document.getElementById('downloadLink').classList.remove('hidden');
                            statusBox.innerText = "âœ… SELESAI!";
                            statusBox.className = "text-center text-xs font-mono text-green-400 pt-2";
                        }
                    }

                    if (msg.msg === 'process_completed') {
                        eventSource.close();
                        btn.disabled = false; btn.innerHTML = 'ðŸš€ GENERATE LAGI'; btn.classList.remove('opacity-50');
                    }
                }
            };

        } catch (err) {
            statusBox.innerText = "âŒ Error: " + err.message;
            statusBox.className = "text-center text-xs font-mono text-red-400 pt-2";
            btn.disabled = false; btn.innerHTML = 'COBA LAGI'; btn.classList.remove('opacity-50');
        }
    }

    // Fungsi Helper Visual
    function activateCard(cardId, statusId, text) {
        document.getElementById(cardId).classList.remove('opacity-50');
        document.getElementById(cardId).classList.add('border-pink-500');
        const st = document.getElementById(statusId);
        st.innerText = text; st.classList.add('text-green-400');
    }
    
    function resetCards() {
        ['cardPhoto', 'cardAudio', 'cardVideo'].forEach(id => {
            const el = document.getElementById(id);
            el.classList.add('opacity-50');
            el.classList.remove('border-pink-500');
        });
        document.getElementById('photoGrid').innerHTML = '<p class="text-xs text-gray-500 col-span-2 text-center pt-8">Menunggu...</p>';
        document.getElementById('audioPlayer').classList.add('hidden');
        document.getElementById('audioPlaceholder').classList.remove('hidden');
        document.getElementById('videoPlayer').classList.add('hidden');
        document.getElementById('videoLoadingText').classList.remove('hidden');
        document.getElementById('downloadLink').classList.add('hidden');
    }
</script>
