<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGC ProMax - Custom UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; transition: 0.3s; }
        .input-field:focus { border-color: #8b5cf6; outline: none; ring: 2px solid rgba(139, 92, 246, 0.3); }
        .loader { border-top-color: #8b5cf6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Hide scrollbar for gallery */
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center bg-no-repeat bg-fixed">
    
    <!-- Overlay Gelap -->
    <div class="absolute inset-0 bg-slate-900/90 z-0"></div>

    <div class="z-10 w-full max-w-4xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">UGC ProMax Generator</h1>
            <p class="text-slate-400 mt-2">Professional Content Generation Tool</p>
        </div>

        <!-- LOGIN SECTION -->
        <div id="loginSection" class="glass rounded-2xl p-8 max-w-md mx-auto shadow-2xl">
            <h2 class="text-2xl font-semibold mb-6 text-center">üîê Login Access</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">Password</label>
                    <input type="password" id="passwordInput" class="input-field w-full p-3 rounded-lg" placeholder="Masukkan password akses...">
                </div>
                <button onclick="doLogin()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02]">
                    Masuk Sekarang
                </button>
                <p id="loginStatus" class="text-center text-sm text-red-400 mt-2 hidden"></p>
            </div>
        </div>

        <!-- MAIN APP SECTION (Hidden Awalnya) -->
        <div id="appSection" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- KOLOM KIRI: INPUT -->
            <div class="glass rounded-2xl p-6 space-y-6 h-fit">
                <h3 class="text-xl font-semibold border-b border-slate-700 pb-3">üõ†Ô∏è Konfigurasi</h3>
                
                <!-- Images -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium mb-2 text-blue-300">Foto Produk (Wajib)</label>
                        <input type="file" id="prodImg" accept="image/*" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-2 text-purple-300">Foto Model (Opsional)</label>
                        <input type="file" id="modelImg" accept="image/*" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"/>
                    </div>
                </div>

                <!-- Text Details -->
                <div class="space-y-3">
                    <input type="text" id="valName" placeholder="Nama Produk" class="input-field w-full p-3 rounded-lg text-sm">
                    <input type="text" id="valPrice" placeholder="Harga (Contoh: Rp 150.000)" class="input-field w-full p-3 rounded-lg text-sm">
                    <textarea id="valPros" rows="3" placeholder="Kelebihan Produk..." class="input-field w-full p-3 rounded-lg text-sm"></textarea>
                </div>

                <!-- Settings -->
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">üé¨ Urutan Animasi</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="animOrder" value="veo_first" checked class="accent-purple-500">
                            <span class="text-sm">VEO ‚Üí Grok</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="animOrder" value="grok_first" class="accent-purple-500">
                            <span class="text-sm">Grok ‚Üí VEO</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-2">
                    <button onclick="runProcess('image')" id="btnImage" class="flex-1 bg-slate-700 hover:bg-slate-600 py-3 rounded-lg font-semibold transition border border-slate-600">
                        üñºÔ∏è Gambar Saja
                    </button>
                    <button onclick="runProcess('full')" id="btnFull" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 py-3 rounded-lg font-semibold text-white shadow-lg transition transform hover:scale-[1.02]">
                        üöÄ Full Pipeline
                    </button>
                </div>
                
                <!-- Progress Loader -->
                <div id="loading" class="hidden flex items-center justify-center gap-3 bg-slate-800/50 p-3 rounded-lg">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-slate-200 h-5 w-5"></div>
                    <span class="text-sm animate-pulse text-purple-300">Sedang memproses AI... (Bisa 2-5 menit)</span>
                </div>
            </div>

            <!-- KOLOM KANAN: OUTPUT -->
            <div class="glass rounded-2xl p-6 flex flex-col h-full min-h-[500px]">
                <h3 class="text-xl font-semibold border-b border-slate-700 pb-3 mb-4">üìä Hasil Generate</h3>
                
                <!-- Logs -->
                <div class="bg-black/30 rounded-lg p-3 mb-4 h-32 overflow-y-auto border border-slate-700 font-mono text-xs text-green-400" id="outputLog">
                    > Menunggu input...
                </div>

                <!-- Result Container -->
                <div class="flex-1 space-y-4 overflow-y-auto hide-scroll">
                    
                    <!-- Video Result -->
                    <div id="videoContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-purple-300">üé• Video Final</p>
                        <video id="resultVideo" controls class="w-full rounded-lg border border-slate-600 shadow-lg bg-black"></video>
                        <a id="downloadVideoBtn" href="#" download="ugc_video.mp4" class="block mt-2 text-center text-sm text-blue-400 hover:text-blue-300 underline">Download Video</a>
                    </div>

                    <!-- Audio Result -->
                    <div id="audioContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-blue-300">üéµ Audio</p>
                        <audio id="resultAudio" controls class="w-full"></audio>
                    </div>

                    <!-- Gallery Result -->
                    <div id="galleryContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-slate-300">üì∏ Galeri Gambar</p>
                        <div id="galleryGrid" class="grid grid-cols-2 gap-2">
                            <!-- Images injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Module -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@0.1.4/dist/index.min.js";

        // Global Variables
        let client;
        let userData = null; // Menyimpan session user setelah login

        // Konfigurasi Space (Ganti dengan space Anda)
        const SPACE_ID = "sumahir/UGCpromax"; 

        // Fungsi Helper: Generate Token Keamanan (Sesuai Logic Python/JS Anda)
        function generateSecurityToken() {
            const secret = "SUMAHIR_SECRET_V99";
            const current_min = Math.floor(Date.now() / 1000 / 60);
            return secret + current_min;
        }

        // ================= LOGIN FUNCTION =================
        window.doLogin = async function() {
            const password = document.getElementById('passwordInput').value;
            const statusEl = document.getElementById('loginStatus');
            const btn = document.querySelector('button[onclick="doLogin()"]');
            
            if (!password) { statusEl.innerText = "Masukkan password!"; statusEl.classList.remove('hidden'); return; }

            btn.innerText = "Memverifikasi...";
            btn.disabled = true;
            statusEl.classList.add('hidden');

            try {
                // Connect ke Space
                client = await Client.connect(SPACE_ID);
                
                // Panggil fungsi handle_login (Biasanya index 0 atau 1 tergantung urutan di Blocks)
                // Kita coba panggil endpoint /predict pertama yang sesuai login
                // Berdasarkan kode Anda: login_btn.click(fn=handle_login...)
                
                const result = await client.predict("/predict", [password]); 
                // Catatan: Nama endpoint default Gradio biasanya /predict, /predict_1, dst.
                // Jika error, coba cek API Info di footer Space HF -> "View API".
                
                // Result biasanya [userData, login_section_update, main_section_update, status_msg]
                // Tapi lewat API client, kita dapat datanya langsung.
                
                const responseData = result.data;
                const userPayload = responseData[0]; // Ini adalah user_data JSON
                const errorMessage = responseData[3]; // Pesan error string

                if (userPayload) {
                    userData = userPayload; // Simpan data user di memori browser
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('appSection').classList.remove('hidden');
                    document.getElementById('appSection').classList.add('fade-in');
                    console.log("Login Success. User Data loaded.");
                } else {
                    throw new Error(errorMessage || "Password Salah");
                }

            } catch (error) {
                console.error(error);
                statusEl.innerText = "Gagal: " + error.message;
                statusEl.classList.remove('hidden');
            } finally {
                btn.innerText = "Masuk Sekarang";
                btn.disabled = false;
            }
        }

        // ================= PROCESS FUNCTION =================
        window.runProcess = async function(mode) {
            const prodImg = document.getElementById('prodImg').files[0];
            const modelImg = document.getElementById('modelImg').files[0];
            const name = document.getElementById('valName').value;
            const price = document.getElementById('valPrice').value;
            const pros = document.getElementById('valPros').value;
            const animOrder = document.querySelector('input[name="animOrder"]:checked').value;
            
            // UI Elements
            const loading = document.getElementById('loading');
            const logBox = document.getElementById('outputLog');
            const videoCont = document.getElementById('videoContainer');
            const audioCont = document.getElementById('audioContainer');
            const galleryCont = document.getElementById('galleryContainer');
            const galleryGrid = document.getElementById('galleryGrid');

            if (!userData) { alert("Sesi habis, silakan refresh dan login lagi."); return; }
            if (!prodImg) { alert("Wajib upload foto produk!"); return; }

            loading.classList.remove('hidden');
            logBox.innerText = "> Memulai proses ke server...\n";
            
            // Reset Output
            videoCont.classList.add('hidden');
            audioCont.classList.add('hidden');
            galleryCont.classList.add('hidden');
            galleryGrid.innerHTML = '';

            try {
                const token = generateSecurityToken();
                console.log("Generated Token:", token);

                let result;
                
                if (mode === 'image') {
                    // Endpoint untuk handle_images_only
                    // Inputs: [user_data, prod, model, name, price, pros, token]
                    // Perlu cek urutan API index yang benar. 
                    // Asumsi: handle_images_only adalah fungsi kedua yang dibuat tombolnya
                    
                    result = await client.predict("/predict_1", [
                        userData, prodImg, modelImg, name, price, pros, token
                    ]);

                    // Outputs: [log, gallery]
                    logBox.innerText = result.data[0];
                    renderGallery(result.data[1]); // Image gallery

                } else {
                    // Endpoint untuk handle_full_pipeline
                    // Inputs: [user, prod, model, name, price, pros, anim_order, token]
                    
                    result = await client.predict("/predict_2", [
                        userData, prodImg, modelImg, name, price, pros, animOrder, token
                    ]);

                    // Outputs: [log, video, audio, gallery]
                    logBox.innerText = result.data[0];
                    
                    // Render Video
                    if (result.data[1]) {
                        const videoUrl = result.data[1].url; // Gradio Client return object {url: ..., orig_name: ...}
                        document.getElementById('resultVideo').src = videoUrl;
                        document.getElementById('downloadVideoBtn').href = videoUrl;
                        videoCont.classList.remove('hidden');
                    }

                    // Render Audio
                    if (result.data[2]) {
                        document.getElementById('resultAudio').src = result.data[2].url;
                        audioCont.classList.remove('hidden');
                    }

                    // Render Gallery
                    renderGallery(result.data[3]);
                }

            } catch (error) {
                console.error(error);
                logBox.innerText += "\n[ERROR] " + error.message;
                alert("Terjadi kesalahan proses. Cek log.");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderGallery(images) {
            const galleryGrid = document.getElementById('galleryGrid');
            const galleryCont = document.getElementById('galleryContainer');
            
            if (images && images.length > 0) {
                images.forEach(img => {
                    // img bisa berupa object {url: ...} atau base64 tergantung config
                    const src = img.url || img; 
                    const imgEl = document.createElement('img');
                    imgEl.src = src;
                    imgEl.className = "w-full h-32 object-cover rounded border border-slate-600 cursor-pointer hover:opacity-80 transition";
                    imgEl.onclick = () => window.open(src, '_blank');
                    galleryGrid.appendChild(imgEl);
                });
                galleryCont.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
