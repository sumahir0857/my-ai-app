<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGC ProMax - Custom UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; transition: 0.3s; }
        .input-field:focus { border-color: #8b5cf6; outline: none; ring: 2px solid rgba(139, 92, 246, 0.3); }
        .loader { border-top-color: #8b5cf6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Tambahan Visual Feedback saat tombol ditekan */
        button:active { transform: scale(0.98); }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center bg-no-repeat bg-fixed">
    
    <div class="absolute inset-0 bg-slate-900/90 z-0"></div>

    <div class="z-10 w-full max-w-4xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">UGC ProMax Generator</h1>
            <p class="text-slate-400 mt-2">Professional Content Generation Tool</p>
        </div>

        <!-- LOGIN SECTION -->
        <div id="loginSection" class="glass rounded-2xl p-8 max-w-md mx-auto shadow-2xl transition-all duration-500">
            <h2 class="text-2xl font-semibold mb-6 text-center">üîê Login Access</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">Password</label>
                    <input type="password" id="passwordInput" class="input-field w-full p-3 rounded-lg" placeholder="Masukkan password akses...">
                </div>
                <!-- ID ditambahkan ke tombol -->
                <button id="btnLogin" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                    Masuk Sekarang
                </button>
                <p id="loginStatus" class="text-center text-sm text-red-400 mt-2 hidden"></p>
                <p id="initStatus" class="text-center text-xs text-slate-500 mt-2 animate-pulse">Menghubungkan ke server...</p>
            </div>
        </div>

        <!-- MAIN APP SECTION -->
        <div id="appSection" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 opacity-0 transition-opacity duration-1000">
            
            <!-- INPUT -->
            <div class="glass rounded-2xl p-6 space-y-6 h-fit">
                <h3 class="text-xl font-semibold border-b border-slate-700 pb-3">üõ†Ô∏è Konfigurasi</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium mb-2 text-blue-300">Foto Produk (Wajib)</label>
                        <input type="file" id="prodImg" accept="image/*" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-2 text-purple-300">Foto Model (Opsional)</label>
                        <input type="file" id="modelImg" accept="image/*" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"/>
                    </div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="valName" placeholder="Nama Produk" class="input-field w-full p-3 rounded-lg text-sm">
                    <input type="text" id="valPrice" placeholder="Harga (Contoh: Rp 150.000)" class="input-field w-full p-3 rounded-lg text-sm">
                    <textarea id="valPros" rows="3" placeholder="Kelebihan Produk..." class="input-field w-full p-3 rounded-lg text-sm"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-300">üé¨ Urutan Animasi</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="animOrder" value="veo_first" checked class="accent-purple-500">
                            <span class="text-sm">VEO ‚Üí Grok</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="animOrder" value="grok_first" class="accent-purple-500">
                            <span class="text-sm">Grok ‚Üí VEO</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button id="btnImage" class="flex-1 bg-slate-700 hover:bg-slate-600 py-3 rounded-lg font-semibold transition border border-slate-600">
                        üñºÔ∏è Gambar Saja
                    </button>
                    <button id="btnFull" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 py-3 rounded-lg font-semibold text-white shadow-lg transition transform hover:scale-[1.02]">
                        üöÄ Full Pipeline
                    </button>
                </div>
                
                <div id="loading" class="hidden flex items-center justify-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-slate-200 h-5 w-5"></div>
                    <span class="text-sm animate-pulse text-purple-300">Sedang memproses AI... (Tunggu 2-5 menit)</span>
                </div>
            </div>

            <!-- OUTPUT -->
            <div class="glass rounded-2xl p-6 flex flex-col h-full min-h-[500px]">
                <h3 class="text-xl font-semibold border-b border-slate-700 pb-3 mb-4">üìä Hasil Generate</h3>
                
                <div class="bg-black/40 rounded-lg p-4 mb-4 h-40 overflow-y-auto border border-slate-700 font-mono text-xs text-green-400 shadow-inner" id="outputLog">
                    > Menunggu login...
                </div>

                <div class="flex-1 space-y-4 overflow-y-auto hide-scroll">
                    <div id="videoContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-purple-300">üé• Video Final</p>
                        <video id="resultVideo" controls class="w-full rounded-lg border border-slate-600 shadow-lg bg-black max-h-[300px]"></video>
                        <a id="downloadVideoBtn" href="#" download="ugc_video.mp4" class="block mt-2 text-center text-sm text-blue-400 hover:text-blue-300 underline">Download Video</a>
                    </div>
                    <div id="audioContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-blue-300">üéµ Audio</p>
                        <audio id="resultAudio" controls class="w-full"></audio>
                    </div>
                    <div id="galleryContainer" class="hidden">
                        <p class="text-sm font-semibold mb-2 text-slate-300">üì∏ Galeri Gambar</p>
                        <div id="galleryGrid" class="grid grid-cols-2 gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT UTAMA -->
    <script type="module">
        // Gunakan versi terbaru yang lebih stabil
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@0.10.0/dist/index.min.js";

        const SPACE_ID = "sumahir/UGCpromax";
        let client;
        let userData = null;

        // UI Element References
        const btnLogin = document.getElementById('btnLogin');
        const btnImage = document.getElementById('btnImage');
        const btnFull = document.getElementById('btnFull');
        const initStatus = document.getElementById('initStatus');

        // --- 1. INITIALIZATION ---
        async function initApp() {
            try {
                console.log("Connecting to Space...");
                // Coba connect
                client = await Client.connect(SPACE_ID);
                console.log("Connected to Space:", SPACE_ID);
                
                // Aktifkan tombol login setelah terkoneksi
                initStatus.innerText = "Terhubung ke server ‚úÖ";
                initStatus.classList.remove('animate-pulse');
                initStatus.classList.add('text-green-500');
                btnLogin.disabled = false;
            } catch (error) {
                console.error("Connection Failed:", error);
                initStatus.innerText = "Gagal terhubung ke HF Space ‚ùå. Coba refresh.";
                initStatus.classList.add('text-red-500');
                alert("Gagal terhubung ke Hugging Face Space. Pastikan Space Anda Public/Running.");
            }
        }

        // Jalankan init saat halaman dimuat
        initApp();

        // --- 2. LOGIN HANDLER ---
        btnLogin.addEventListener('click', async () => {
            const password = document.getElementById('passwordInput').value;
            const statusEl = document.getElementById('loginStatus');

            if (!password) { 
                statusEl.innerText = "Masukkan password!"; 
                statusEl.classList.remove('hidden'); 
                return; 
            }
            if (!client) { alert("Belum terhubung ke server. Tunggu sebentar..."); return; }

            btnLogin.innerText = "Memverifikasi...";
            btnLogin.classList.add('disabled-btn');
            statusEl.classList.add('hidden');

            try {
                // Prediksi Endpoint Login. 
                // Biasanya event handler pertama = /predict, kedua = /predict_1, dst.
                // Di kode Python Anda: login_btn.click (kemungkinan /predict)
                
                const result = await client.predict("/predict", [password]);
                
                // Result structure: [user_data, login_ui_update, main_ui_update, error_msg]
                const data = result.data;
                const userPayload = data[0];
                const errorMsg = data[3];

                if (userPayload) {
                    userData = userPayload; // Simpan sesi
                    
                    // Transisi UI
                    document.getElementById('loginSection').classList.add('hidden');
                    const appSection = document.getElementById('appSection');
                    appSection.classList.remove('hidden');
                    setTimeout(() => appSection.classList.remove('opacity-0'), 100);
                    
                    document.getElementById('outputLog').innerText = "> Login sukses!\n> Siap generate konten.";
                } else {
                    throw new Error(errorMsg || "Password salah!");
                }

            } catch (error) {
                console.error(error);
                statusEl.innerText = error.message.includes("Could not find") 
                    ? "API Error: Cek Console (F12)" 
                    : "Gagal: " + error.message;
                statusEl.classList.remove('hidden');
            } finally {
                btnLogin.innerText = "Masuk Sekarang";
                btnLogin.classList.remove('disabled-btn');
            }
        });

        // --- 3. HELPER: TOKEN GENERATOR ---
        function generateSecurityToken() {
            const secret = "SUMAHIR_SECRET_V99";
            const current_min = Math.floor(Date.now() / 1000 / 60);
            return secret + current_min;
        }

        // --- 4. IMAGE GENERATION HANDLER ---
        btnImage.addEventListener('click', async () => {
            await runProcess('image');
        });

        // --- 5. FULL PIPELINE HANDLER ---
        btnFull.addEventListener('click', async () => {
            await runProcess('full');
        });

        // --- CORE PROCESS FUNCTION ---
        async function runProcess(mode) {
            if (!userData) { alert("Sesi habis. Refresh halaman."); return; }
            
            const prodImg = document.getElementById('prodImg').files[0];
            const modelImg = document.getElementById('modelImg').files[0]; // Bisa undefined
            const name = document.getElementById('valName').value;
            const price = document.getElementById('valPrice').value;
            const pros = document.getElementById('valPros').value;
            const animOrder = document.querySelector('input[name="animOrder"]:checked').value;

            if (!prodImg) { alert("Upload foto produk dulu!"); return; }

            // UI Updates
            const loading = document.getElementById('loading');
            const logBox = document.getElementById('outputLog');
            const btn = mode === 'image' ? btnImage : btnFull;

            loading.classList.remove('hidden');
            btn.classList.add('disabled-btn');
            logBox.innerText += `\n> Memulai proses (${mode})...`;

            try {
                const token = generateSecurityToken();
                let result;

                // IMPORTANT: Menentukan Endpoint ID
                // Berdasarkan kode Python Anda, urutan tombol:
                // 1. login_btn -> /predict
                // 2. password_input.submit -> /predict_1
                // 3. btn_images_only -> /predict_2
                // 4. btn_full_pipeline -> /predict_3
                
                if (mode === 'image') {
                    // /predict_2 inputs: [user, prod, model, name, price, pros, token]
                    result = await client.predict("/predict_2", [
                        userData, prodImg, modelImg, name, price, pros, token
                    ]);
                    
                    // Output: [log, gallery]
                    logBox.innerText = result.data[0];
                    renderGallery(result.data[1]);

                } else {
                    // /predict_3 inputs: [user, prod, model, name, price, pros, animOrder, token]
                    result = await client.predict("/predict_3", [
                        userData, prodImg, modelImg, name, price, pros, animOrder, token
                    ]);

                    // Output: [log, video, audio, gallery]
                    logBox.innerText = result.data[0];
                    
                    if (result.data[1]) {
                        const vidUrl = result.data[1].url;
                        document.getElementById('resultVideo').src = vidUrl;
                        document.getElementById('downloadVideoBtn').href = vidUrl;
                        document.getElementById('videoContainer').classList.remove('hidden');
                    }
                    if (result.data[2]) {
                        document.getElementById('resultAudio').src = result.data[2].url;
                        document.getElementById('audioContainer').classList.remove('hidden');
                    }
                    renderGallery(result.data[3]);
                }

            } catch (error) {
                console.error("Process Error:", error);
                logBox.innerText += `\n[ERROR] ${error.message}`;
                alert("Terjadi error. Cek log di bawah.");
            } finally {
                loading.classList.add('hidden');
                btn.classList.remove('disabled-btn');
            }
        }

        function renderGallery(images) {
            const grid = document.getElementById('galleryGrid');
            const container = document.getElementById('galleryContainer');
            grid.innerHTML = '';
            
            if (images && images.length > 0) {
                images.forEach(img => {
                    // Gradio return object { url: "...", orig_name: "..." }
                    const src = img.url; 
                    const imgEl = document.createElement('img');
                    imgEl.src = src;
                    imgEl.className = "w-full h-32 object-cover rounded border border-slate-600 cursor-pointer hover:opacity-80 transition";
                    imgEl.onclick = () => window.open(src, '_blank');
                    grid.appendChild(imgEl);
                });
                container.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
